<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Call</title>
<style>
body{margin:0;padding:0;background:#222;color:white;font-family:'Poppins',sans-serif;display:flex;flex-direction:column;align-items:center;}
#videoContainer{position:relative;width:100%;max-width:900px;height:500px;margin-top:20px;}
video{border-radius:10px;position:absolute;object-fit:cover;}
#localVideo{width:200px;height:150px;bottom:20px;right:20px;z-index:2;cursor:move;box-shadow:0 0 10px #000;}
#remoteVideo{width:100%;height:100%;top:0;left:0;}
button{padding:10px 15px;margin:15px;border:none;border-radius:6px;background:#ff416c;color:white;cursor:pointer;}
</style>
</head>
<body>

<h2>Live Call</h2>
<div id="videoContainer">
  <video id="remoteVideo" autoplay></video>
  <video id="localVideo" autoplay muted></video>
</div>

<button onclick="endCall()">End Call</button>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// ðŸ”¹ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCf6oj1SwC9FIetbI_TAxKNmpx0qm4zrvQ",
  authDomain: "puja-fun-service.firebaseapp.com",
  databaseURL: "https://puja-fun-service-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "puja-fun-service",
  storageBucket: "puja-fun-service.appspot.com",
  messagingSenderId: "559424092727",
  appId: "1:559424092727:web:35f7180b49b0a748c95db2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ðŸ”¹ Logged-in user
let loggedUser = JSON.parse(localStorage.getItem("loggedUser"));
if(!loggedUser){ alert("Login first"); window.location.href="login.html"; }

// ðŸ”¹ Get callId from URL
const urlParams = new URLSearchParams(window.location.search);
const callId = urlParams.get("callId");
if(!callId){ alert("No callId"); window.location.href=loggedUser.role==='model'?'dashboard_model.html':'dashboard_user.html'; }

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
let localStream, peerConnection;

const servers = {iceServers:[{urls:"stun:stun.l.google.com:19302"}]};
const callRef = db.ref("calls/"+callId+"/signal");

// ðŸ”¹ Start Call
async function startCall(){
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject = localStream;

  peerConnection = new RTCPeerConnection(servers);
  localStream.getTracks().forEach(track=>peerConnection.addTrack(track, localStream));

  peerConnection.ontrack = event => { remoteVideo.srcObject = event.streams[0]; };

  peerConnection.onicecandidate = event => {
    if(event.candidate) callRef.push({candidate:event.candidate});
  };

  // Listen remote SDP & ICE
  callRef.on("child_added", snap=>{
    const data = snap.val();
    if(data.sdp){
      peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
      if(data.sdp.type==="offer" && loggedUser.uid!==callData.from){
        peerConnection.createAnswer().then(answer=>{
          peerConnection.setLocalDescription(answer);
          callRef.push({sdp:answer});
        });
      }
    } else if(data.candidate){
      peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
    }
  });

  // Get callData
  const callSnap = await db.ref("calls/"+callId).once("value");
  const callData = callSnap.val();
  if(callData.from===loggedUser.uid){
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    callRef.push({sdp:offer});
  }
}

startCall();

// ðŸ”¹ End Call
function endCall(){
  peerConnection.close();
  localStream.getTracks().forEach(track=>track.stop());
  db.ref("calls/"+callId).update({status:"ended"});
  window.location.href = loggedUser.role==='model'?'dashboard_model.html':'dashboard_user.html';
}

// ðŸ”¹ Drag small video (PiP)
const pip = document.getElementById("localVideo");
let isDragging=false, offsetX=0, offsetY=0;
pip.addEventListener("mousedown", e=>{
  isDragging=true;
  offsetX=e.offsetX;
  offsetY=e.offsetY;
});
document.addEventListener("mouseup", ()=>isDragging=false);
document.addEventListener("mousemove", e=>{
  if(isDragging){
    pip.style.right='auto';
    pip.style.bottom='auto';
    pip.style.left = (e.clientX-offsetX)+'px';
    pip.style.top = (e.clientY-offsetY)+'px';
  }
});
pip.addEventListener("dblclick", ()=>{
  // Swap size: make local full screen
  if(pip.style.width==='100%'){
    pip.style.width='200px';
    pip.style.height='150px';
    remoteVideo.style.width='100%';
    remoteVideo.style.height='100%';
  } else {
    pip.style.width='100%';
    pip.style.height='100%';
    remoteVideo.style.width='200px';
    remoteVideo.style.height='150px';
    remoteVideo.style.top='20px';
    remoteVideo.style.left='20px';
  }
});
</script>

</body>
</html>