<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat â€” Online Fun Service</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
  import { getAuth } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
  import { getDatabase, ref, push, onValue } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

  const firebaseConfig = {
    apiKey: "REPLACE_API_KEY",
    authDomain: "REPLACE_PROJECT.firebaseapp.com",
    databaseURL: "https://REPLACE_PROJECT.firebaseio.com",
    projectId: "REPLACE_PROJECT",
    storageBucket: "REPLACE_PROJECT.appspot.com",
    messagingSenderId: "REPLACE_SENDER_ID",
    appId: "REPLACE_APP_ID"
  };

  window._ofs = {};
  window._ofs.app = initializeApp(firebaseConfig);
  window._ofs.auth = getAuth(window._ofs.app);
  window._ofs.db = getDatabase(window._ofs.app);
  window._ofs.makeEmailFromMobile = (mobile) => `${mobile.replace(/[^0-9]/g,'') || Date.now()}@ofs.local`;
  </script>
</head>
<body class="container py-4">
  <h4>Chat</h4>
  <div id="messages" style="height:400px;overflow:auto;border:1px solid #ddd;padding:10px"></div>
  <div class="input-group mt-2">
    <input id="txt" class="form-control" placeholder="Type message" />
    <button id="sendBtn" class="btn btn-primary">Send</button>
  </div>

  <script type="module">
    const urlParams = new URLSearchParams(location.search);
    const peerId = urlParams.get('peer');
    const session = JSON.parse(sessionStorage.getItem('ofs_user') || 'null');
    if (!session) { location = 'login.html'; }
    if (!peerId) { alert('No peer specified'); location = 'user-dashboard.html'; }
    const db = window._ofs.db;
    const chatId = [session.uid, peerId].sort().join('_');
    const messagesDiv = document.getElementById('messages');

    onValue(ref(db, 'chats/' + chatId + '/messages'), (snap) => {
      messagesDiv.innerHTML = '';
      snap.forEach((c) => {
        const m = c.val();
        const div = document.createElement('div');
        div.innerHTML = `<small class="text-muted">${new Date(m.ts).toLocaleTimeString()}</small><div><strong>${m.fromName || m.from}</strong>: ${m.text}</div>`;
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    document.getElementById('sendBtn').addEventListener('click', async () => {
      const text = document.getElementById('txt').value.trim();
      if (!text) return;
      await push(ref(db, 'chats/' + chatId + '/messages'), { from: session.uid, fromName: session.name, text, ts: Date.now() });
      document.getElementById('txt').value = '';
    });
  </script>
</body>
</html>
